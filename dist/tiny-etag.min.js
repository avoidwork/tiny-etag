/*!
 2022 Jason Mulligan <jason.mulligan@avoidwork.com>
 @version 3.0.0
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("node:util"),require("tiny-lru"),require("murmurhash3js")):"function"==typeof define&&define.amd?define(["exports","node:util","tiny-lru","murmurhash3js"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).etag={},e.node_util,e.tinyLru,e.MurmurHash3)}(this,(function(e,t,r,n){"use strict";function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}const i=s(n).default.x64.hash128;function a(e){return JSON.parse(JSON.stringify(e,null,0))}class o{constructor(e,t,n,s){this.cache=r.lru(e,t),this.mimetype=s,this.seed=n}create(e){return`"${i(e,this.seed)}"`}middleware(e,r,n){if("GET"===e.method){const i=(e.parsed||(s=e,new t.URL("string"==typeof s?s:`http://${s.headers.host||`localhost:${s.socket.server._connectionKey.replace(/.*::/,"")}`}${s.url}`))).href,o=this.hash(i,e.headers.accept),c=this.cache.get(o);if(r.on("finish",(()=>{const e=r.getHeaders(),t=r.statusCode;(200===t||304===t)&&"etag"in e&&this.valid(e)&&this.register(o,{etag:e.etag,headers:e,timestamp:c?c.timestamp:Math.floor((new Date).getTime()/1e3)})})),void 0!==c&&"etag"in c&&"range"in e.headers==!1&&e.headers["if-none-match"]===c.etag){const e=a(c.headers);e.age=Math.floor((new Date).getTime()/1e3)-c.timestamp,r.removeHeader("cache-control"),r.send("",304,e)}else n()}else n();var s}hash(e="",t=""){return this.create(`${e}_${t||this.mimetype}`)}register(e,t){const r=a(t);return r.headers=Object.keys(r.headers).filter((e=>function(e){return"cache-control"===e||"content-location"===e||"date"===e||"etag"===e||"expires"===e||"vary"===e}(e.toLowerCase()))).reduce(((e,t)=>(e[t]=r.headers[t],e)),{}),this.cache.set(e,r),this}unregister(e){this.cache.delete(e)}valid(e){const t=e["cache-control"]||"";return 0===t.length||!1===t.includes("no-cache")&&!1===t.includes("no-store")}}e.etag=function({cacheSize:e=1e3,cacheTTL:t=0,seed:r=null,mimetype:n="text/plain"}={}){const s=new o(e,t,null!==r?r:Math.floor(Math.random()*e)+1,n);return s.middleware=s.middleware.bind(s),s},Object.defineProperty(e,"__esModule",{value:!0})}));//# sourceMappingURL=tiny-etag.min.js.map
