/*!
 2022 Jason Mulligan <jason.mulligan@avoidwork.com>
 @version 3.0.1
*/
import{URL as e}from"node:url";import{lru as t}from"tiny-lru";import r from"murmurhash3js";const s=r.x86.hash32;function a(e){return JSON.parse(JSON.stringify(e,null,0))}class n{constructor(e,r,s,a){this.cache=t(e,r),this.mimetype=a,this.seed=s}create(e){return`"${s(e,this.seed)}"`}middleware(t,r,s){if("GET"===t.method){const i=(t.parsed||(n=t,new e("string"==typeof n?n:`http://${n.headers.host||`localhost:${n.socket.server._connectionKey.replace(/.*::/,"")}`}${n.url}`))).href,o=this.hash(i,t.headers.accept),c=this.cache.get(o);if(r.on("finish",(()=>{const e=r.getHeaders(),t=r.statusCode;(200===t||304===t)&&"etag"in e&&this.valid(e)&&this.register(o,{etag:e.etag,headers:e,timestamp:c?c.timestamp:Math.floor((new Date).getTime()/1e3)})})),void 0!==c&&"etag"in c&&"range"in t.headers==!1&&t.headers["if-none-match"]===c.etag){const e=a(c.headers);e.age=Math.floor((new Date).getTime()/1e3)-c.timestamp,r.removeHeader("cache-control"),r.send("",304,e)}else s()}else s();var n}hash(e="",t=""){return this.create(`${e}_${t||this.mimetype}`)}register(e,t){const r=a(t);return r.headers=Object.keys(r.headers).filter((e=>function(e){return"cache-control"===e||"content-location"===e||"date"===e||"etag"===e||"expires"===e||"vary"===e}(e.toLowerCase()))).reduce(((e,t)=>(e[t]=r.headers[t],e)),{}),this.cache.set(e,r),this}unregister(e){this.cache.delete(e)}valid(e){const t=e["cache-control"]||"";return 0===t.length||!1===t.includes("no-cache")&&!1===t.includes("no-store")}}function i({cacheSize:e=1e3,cacheTTL:t=0,seed:r=null,mimetype:s="text/plain"}={}){const a=new n(e,t,null!==r?r:Math.floor(Math.random()*e)+1,s);return a.middleware=a.middleware.bind(a),a}export{i as etag};//# sourceMappingURL=tiny-etag.esm.min.js.map
