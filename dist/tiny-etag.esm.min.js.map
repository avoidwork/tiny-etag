{"version":3,"file":"tiny-etag.esm.min.js","sources":["../src/etag.js"],"sourcesContent":["import {URL} from \"node:util\";\nimport {lru} from \"tiny-lru\";\nimport MurmurHash3 from \"murmurhash3js\";\nconst mmh3 = MurmurHash3.x64.hash128;\n\nfunction clone (arg) {\n\treturn JSON.parse(JSON.stringify(arg, null, 0));\n}\n\nfunction keep (arg) {\n\treturn arg === \"cache-control\" || arg === \"content-location\" || arg === \"date\" || arg === \"etag\" || arg === \"expires\" || arg === \"vary\";\n}\n\nfunction parse (arg) {\n\treturn new URL(typeof arg === \"string\" ? arg : `http://${arg.headers.host || `localhost:${arg.socket.server._connectionKey.replace(/.*::/, \"\")}`}${arg.url}`);\n}\n\nclass ETag {\n\tconstructor (cacheSize, cacheTTL, seed, mimetype) {\n\t\tthis.cache = lru(cacheSize, cacheTTL);\n\t\tthis.mimetype = mimetype;\n\t\tthis.seed = seed;\n\t}\n\n\tcreate (arg) {\n\t\treturn `\"${mmh3(arg, this.seed)}\"`;\n\t}\n\n\tmiddleware (req, res, next) {\n\t\tif (req.method === \"GET\") {\n\t\t\tconst uri = (req.parsed || parse(req)).href,\n\t\t\t\tkey = this.hash(uri, req.headers.accept),\n\t\t\t\tcached = this.cache.get(key);\n\n\t\t\tres.on(\"finish\", () => {\n\t\t\t\tconst headers = res.getHeaders(),\n\t\t\t\t\tstatus = res.statusCode;\n\n\t\t\t\tif ((status === 200 || status === 304) && \"etag\" in headers && this.valid(headers)) {\n\t\t\t\t\tthis.register(key, {\n\t\t\t\t\t\tetag: headers.etag,\n\t\t\t\t\t\theaders: headers,\n\t\t\t\t\t\ttimestamp: cached ? cached.timestamp : Math.floor(new Date().getTime() / 1000)\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (cached !== void 0 && \"etag\" in cached && \"range\" in req.headers === false && req.headers[\"if-none-match\"] === cached.etag) {\n\t\t\t\tconst headers = clone(cached.headers);\n\n\t\t\t\theaders.age = Math.floor(new Date().getTime() / 1000) - cached.timestamp;\n\t\t\t\tres.removeHeader(\"cache-control\");\n\t\t\t\tres.send(\"\", 304, headers);\n\t\t\t} else {\n\t\t\t\tnext();\n\t\t\t}\n\t\t} else {\n\t\t\tnext();\n\t\t}\n\t}\n\n\thash (arg = \"\", mimetype = \"\") {\n\t\treturn this.create(`${arg}_${mimetype || this.mimetype}`);\n\t}\n\n\tregister (key, arg) {\n\t\tconst state = clone(arg);\n\n\t\tstate.headers = Object.keys(state.headers).filter(i => keep(i.toLowerCase())).reduce((a, v) => {\n\t\t\ta[v] = state.headers[v];\n\n\t\t\treturn a;\n\t\t}, {});\n\n\t\tthis.cache.set(key, state);\n\n\t\treturn this;\n\t}\n\n\tunregister (key) {\n\t\tthis.cache.delete(key);\n\t}\n\n\tvalid (headers) {\n\t\tconst header = headers[\"cache-control\"] || \"\";\n\n\t\treturn header.length === 0 || (header.includes(\"no-cache\") === false && header.includes(\"no-store\") === false); // eslint-disable-line no-extra-parens\n\t}\n}\n\nexport function etag ({cacheSize = 1e3, cacheTTL = 0, seed = null, mimetype = \"text/plain\"} = {}) {\n\tconst obj = new ETag(cacheSize, cacheTTL, seed !== null ? seed : Math.floor(Math.random() * cacheSize) + 1, mimetype);\n\n\tobj.middleware = obj.middleware.bind(obj);\n\n\treturn obj;\n}\n"],"names":["URL","lru","MurmurHash3","mmh3","x64","hash128","clone","arg","JSON","parse","stringify","ETag","constructor","cacheSize","cacheTTL","seed","mimetype","this","cache","create","middleware","req","res","next","method","uri","parsed","headers","host","socket","server","_connectionKey","replace","url","href","key","hash","accept","cached","get","on","getHeaders","status","statusCode","valid","register","etag","timestamp","Math","floor","Date","getTime","age","removeHeader","send","state","Object","keys","filter","i","keep","toLowerCase","reduce","a","v","set","unregister","delete","header","length","includes","obj","random","bind"],"mappings":";;;;cAGAA,MAAA,0BAAAC,MAAA,kBAAAC,MAAA,gBAAA,MAAMC,EAAOD,EAAYE,IAAIC,QAE7B,SAASC,EAAOC,GACf,OAAOC,KAAKC,MAAMD,KAAKE,UAAUH,EAAK,KAAM,GAC7C,CAUA,MAAMI,EACLC,YAAaC,EAAWC,EAAUC,EAAMC,GACvCC,KAAKC,MAAQjB,EAAIY,EAAWC,GAC5BG,KAAKD,SAAWA,EAChBC,KAAKF,KAAOA,CACZ,CAEDI,OAAQZ,GACP,MAAO,IAAIJ,EAAKI,EAAKU,KAAKF,QAC1B,CAEDK,WAAYC,EAAKC,EAAKC,GACrB,GAAmB,QAAfF,EAAIG,OAAkB,CACzB,MAAMC,GAAOJ,EAAIK,SAjBJnB,EAiBoBc,EAhB5B,IAAIrB,EAAmB,iBAARO,EAAmBA,EAAM,UAAUA,EAAIoB,QAAQC,MAAQ,aAAarB,EAAIsB,OAAOC,OAAOC,eAAeC,QAAQ,OAAQ,QAAQzB,EAAI0B,SAgB9GC,KACtCC,EAAMlB,KAAKmB,KAAKX,EAAKJ,EAAIM,QAAQU,QACjCC,EAASrB,KAAKC,MAAMqB,IAAIJ,GAezB,GAbAb,EAAIkB,GAAG,UAAU,KAChB,MAAMb,EAAUL,EAAImB,aACnBC,EAASpB,EAAIqB,YAEE,MAAXD,GAA6B,MAAXA,IAAmB,SAAUf,GAAWV,KAAK2B,MAAMjB,IACzEV,KAAK4B,SAASV,EAAK,CAClBW,KAAMnB,EAAQmB,KACdnB,QAASA,EACToB,UAAWT,EAASA,EAAOS,UAAYC,KAAKC,OAAM,IAAIC,MAAOC,UAAY,MAE1E,SAGa,IAAXb,GAAqB,SAAUA,GAAU,UAAWjB,EAAIM,UAAY,GAASN,EAAIM,QAAQ,mBAAqBW,EAAOQ,KAAM,CAC9H,MAAMnB,EAAUrB,EAAMgC,EAAOX,SAE7BA,EAAQyB,IAAMJ,KAAKC,OAAM,IAAIC,MAAOC,UAAY,KAAQb,EAAOS,UAC/DzB,EAAI+B,aAAa,iBACjB/B,EAAIgC,KAAK,GAAI,IAAK3B,EACtB,MACIJ,GAEJ,MACGA,IA5CH,IAAgBhB,CA8Cd,CAED6B,KAAM7B,EAAM,GAAIS,EAAW,IAC1B,OAAOC,KAAKE,OAAO,GAAGZ,KAAOS,GAAYC,KAAKD,WAC9C,CAED6B,SAAUV,EAAK5B,GACd,MAAMgD,EAAQjD,EAAMC,GAUpB,OARAgD,EAAM5B,QAAU6B,OAAOC,KAAKF,EAAM5B,SAAS+B,QAAOC,GA3DpD,SAAepD,GACd,MAAe,kBAARA,GAAmC,qBAARA,GAAsC,SAARA,GAA0B,SAARA,GAA0B,YAARA,GAA6B,SAARA,CAC1H,CAyDyDqD,CAAKD,EAAEE,iBAAgBC,QAAO,CAACC,EAAGC,KACxFD,EAAEC,GAAKT,EAAM5B,QAAQqC,GAEdD,IACL,CAAE,GAEL9C,KAAKC,MAAM+C,IAAI9B,EAAKoB,GAEbtC,IACP,CAEDiD,WAAY/B,GACXlB,KAAKC,MAAMiD,OAAOhC,EAClB,CAEDS,MAAOjB,GACN,MAAMyC,EAASzC,EAAQ,kBAAoB,GAE3C,OAAyB,IAAlByC,EAAOC,SAAiD,IAAhCD,EAAOE,SAAS,cAAyD,IAAhCF,EAAOE,SAAS,WACxF,EAGK,SAASxB,GAAMjC,UAACA,EAAY,IAAGC,SAAEA,EAAW,EAACC,KAAEA,EAAO,KAAIC,SAAEA,EAAW,cAAgB,CAAA,GAC7F,MAAMuD,EAAM,IAAI5D,EAAKE,EAAWC,EAAmB,OAATC,EAAgBA,EAAOiC,KAAKC,MAAMD,KAAKwB,SAAW3D,GAAa,EAAGG,GAI5G,OAFAuD,EAAInD,WAAamD,EAAInD,WAAWqD,KAAKF,GAE9BA,CACR,QAAAzB"}