{"version":3,"file":"tiny-etag.min.js","sources":["../src/etag.js"],"sourcesContent":["import {URL} from \"node:util\";\nimport {lru} from \"tiny-lru\";\nimport MurmurHash3 from \"murmurhash3js\";\nconst mmh3 = MurmurHash3.x64.hash128;\n\nfunction clone (arg) {\n\treturn JSON.parse(JSON.stringify(arg, null, 0));\n}\n\nfunction keep (arg) {\n\treturn arg === \"cache-control\" || arg === \"content-location\" || arg === \"date\" || arg === \"etag\" || arg === \"expires\" || arg === \"vary\";\n}\n\nfunction parse (arg) {\n\treturn new URL(typeof arg === \"string\" ? arg : `http://${arg.headers.host || `localhost:${arg.socket.server._connectionKey.replace(/.*::/, \"\")}`}${arg.url}`);\n}\n\nclass ETag {\n\tconstructor (cacheSize, cacheTTL, seed, mimetype) {\n\t\tthis.cache = lru(cacheSize, cacheTTL);\n\t\tthis.mimetype = mimetype;\n\t\tthis.seed = seed;\n\t}\n\n\tcreate (arg) {\n\t\treturn `\"${mmh3(arg, this.seed)}\"`;\n\t}\n\n\tmiddleware (req, res, next) {\n\t\tif (req.method === \"GET\") {\n\t\t\tconst uri = (req.parsed || parse(req)).href,\n\t\t\t\tkey = this.hash(uri, req.headers.accept),\n\t\t\t\tcached = this.cache.get(key);\n\n\t\t\tres.on(\"finish\", () => {\n\t\t\t\tconst headers = res.getHeaders(),\n\t\t\t\t\tstatus = res.statusCode;\n\n\t\t\t\tif ((status === 200 || status === 304) && \"etag\" in headers && this.valid(headers)) {\n\t\t\t\t\tthis.register(key, {\n\t\t\t\t\t\tetag: headers.etag,\n\t\t\t\t\t\theaders: headers,\n\t\t\t\t\t\ttimestamp: cached ? cached.timestamp : Math.floor(new Date().getTime() / 1000)\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (cached !== void 0 && \"etag\" in cached && \"range\" in req.headers === false && req.headers[\"if-none-match\"] === cached.etag) {\n\t\t\t\tconst headers = clone(cached.headers);\n\n\t\t\t\theaders.age = Math.floor(new Date().getTime() / 1000) - cached.timestamp;\n\t\t\t\tres.removeHeader(\"cache-control\");\n\t\t\t\tres.send(\"\", 304, headers);\n\t\t\t} else {\n\t\t\t\tnext();\n\t\t\t}\n\t\t} else {\n\t\t\tnext();\n\t\t}\n\t}\n\n\thash (arg = \"\", mimetype = \"\") {\n\t\treturn this.create(`${arg}_${mimetype || this.mimetype}`);\n\t}\n\n\tregister (key, arg) {\n\t\tconst state = clone(arg);\n\n\t\tstate.headers = Object.keys(state.headers).filter(i => keep(i.toLowerCase())).reduce((a, v) => {\n\t\t\ta[v] = state.headers[v];\n\n\t\t\treturn a;\n\t\t}, {});\n\n\t\tthis.cache.set(key, state);\n\n\t\treturn this;\n\t}\n\n\tunregister (key) {\n\t\tthis.cache.delete(key);\n\t}\n\n\tvalid (headers) {\n\t\tconst header = headers[\"cache-control\"] || \"\";\n\n\t\treturn header.length === 0 || (header.includes(\"no-cache\") === false && header.includes(\"no-store\") === false); // eslint-disable-line no-extra-parens\n\t}\n}\n\nexport function etag ({cacheSize = 1e3, cacheTTL = 0, seed = null, mimetype = \"text/plain\"} = {}) {\n\tconst obj = new ETag(cacheSize, cacheTTL, seed !== null ? seed : Math.floor(Math.random() * cacheSize) + 1, mimetype);\n\n\tobj.middleware = obj.middleware.bind(obj);\n\n\treturn obj;\n}\n"],"names":["g","f","exports","module","require","define","amd","globalThis","self","etag","node_util","tinyLru","MurmurHash3","this","_interopDefaultLegacy","e","default","mmh3","x64","hash128","clone","arg","JSON","parse","stringify","ETag","constructor","cacheSize","cacheTTL","seed","mimetype","cache","lru","create","middleware","req","res","next","method","uri","parsed","URL","headers","host","socket","server","_connectionKey","replace","url","href","key","hash","accept","cached","get","on","getHeaders","status","statusCode","valid","register","timestamp","Math","floor","Date","getTime","age","removeHeader","send","state","Object","keys","filter","i","keep","toLowerCase","reduce","a","v","set","unregister","delete","header","length","includes","obj","random","bind","defineProperty","value"],"mappings":"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"}